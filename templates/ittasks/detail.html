{% extends 'objects/index.html' %}
{% from objects.models import Setting %]
{% block head_css %}
{{ block.super }}
<script>
                $(document).ready(function() {
                    addenabledfunc($("#enabletask"))
                    addclosefunc($("#closebtn"))
                    addchangeuserfunc($("#id_form-0-user"))
                });
                function addchangeuserfunc(ctl) {
                    ctl.after("&nbsp;&nbsp;<span style='display: inline-block' id='id_form-0-user-icon' class='ui-icon ui-icon-check'></span>");
                    ctl.change(function(event) {
                        $("#id_form-0-user-icon").removeClass("ui-icon-check").addClass("ui-icon-pencil");
                        $.post(
                            '{% url 'ittasks:updateuser' obj.id %}',
                             { 'csrfmiddlewaretoken': '{{ csrf_token }}' ,'new_user': this.value},
                             function(data) {
                                if (data.success) {
                                    window.setTimeout(function() {
                                        $("#id_form-0-user-icon").removeClass("ui-icon-pencil").addClass("ui-icon-check");
                                    }, 1000);
                                } else {
                                    alert("aggiornamento non riuscito, provare a ricaricare la pagina")
                                }
                             }
                        );
                        event.preventDefault()
                    });
                }
                function addenabledfunc(ctl) {
                    ctl.click(function(event) {
                        $.getJSON(
                            '{% url 'ittasks:setenabledtask' obj.id %}',
                             function(data) {
                                $("#enabletask").text(data.enabled?"disabilita":"abilita");
                                $("#taskstatus").text(data.enabled?"abilitato":"disabilitato");
                                $("#enabletask").removeClass("btn-info").addClass("btn-success");
                                window.setTimeout(function() {
                                    $("#enabletask").removeClass("btn-success").addClass("btn-info");
                                }, 1500);

                             }
                        );
                        event.preventDefault()
                    });
                }
                function addclosefunc(ctl) {
                    ctl.click(function(event) {
                        $.getJSON(
                            '{% url 'ittasks:closetask' obj.id %}',
                             function(data) {
                                document.location.href = data.redirect
                             }
                        );
                        event.preventDefault()
                    });
                }


</script>
{% endblock head_css %}
{% block body_contents %}
<div class="row">
        <div class="col-lg-6 round-box">
            <h3>{{ obj.template.name }}</h3>

            <p>
                {{ obj.hardwareobject.name }}
                &nbsp;&nbsp;&nbsp;
                <a class="btn btn-xs btn-primary" target="_blank"
                   href="{% url 'objects:detail' obj.hardwareobject.id %}">
                    {% include "icon.html" with iconname='search' %}</a>
            </p>
            <p>{{ obj.hardwareobject.worksite.customer.name }}</p>
            <p>{{ obj.hardwareobject.worksite.name }}</p>
        </div>
    <div class="col-lg-6 round-box">
        <h3>Dati attivit&agrave;</h3>

        <p>
            Esecuzione: {{ obj.laststart }} {% if not obj.done %}
            (<span id="taskstatus">{{ obj.enabled|yesno:"abilitato,disabilitato,mai" }}</span>)
            <button style="width:65px;" class="btn btn-info btn-xs" id="enabletask" class="button">
                {{ obj.enabled|yesno:"disabilita,abilita,mai" }}
            </button>
            {% endif %}
        </p>
        <p>Completato: {{ obj.done|yesno:"si,no,mai" }}</p>
        {% if not obj.done %}
        <p>Prossima: {{ obj.nextstart }}</p>
        {% for formuser in formsetuser %}
        <p>Utente assegnato: {{ formuser.user }}</p>
        {% endfor %}
        <p class="text-right">
            <button id="closebtn" class="btn btn-primary">Completa e chiudi</button>
        </p>
        {% else %}
        <p>Operatore: {{ obj.user.get_full_name }}</p>
        {% endif %}
    </div>
    </div>
<div class="row">
    <div class="col-lg-12 round-box">
        {% if not obj.done %}
        <h3>Controlli da eseguire
            <small>
                <a class="btn btn-info" href="{% url 'ittasks:updatechecks' obj.id %}">Aggiorna i controlli</a>
            </small>
            {% else %}
            <h3>Controlli eseguiti
            {% endif %}
        </h3>
        <form method="post" action="">
            {% csrf_token %}
            {{ formset.management_form }}
            <table class="table table-bordered">
                <tr>
                    <th>Nome</th>
                    <th>Data esecuzione</th>
                    <th>Esito</th>
                    <th colspan="2">Annotazioni</th>
                </tr>
                {% for form in formset %}
                <tr>
                    <td>
                        <dl>
                            <dt>{{ form.instance.checktemplate.name }}</dt>
                            <dd>{{ form.instance.checktemplate.description }}</dd>
                        </dl>
                    </td>
                    <td>
                        {{ form.instance.exectime }}
                        {{ form.id }}
                        {{ form.task }}
                        {{ form.checktemplate }}
                        {{ form.exectime }}
                    </td>
                    {% if not obj.done %}
                    <td>
                        {{ form.result }}
                    </td>
                    <td>
                        {{ form.note }}
                    </td>
                    <td style="text-align:center;vertical-align: middle;">
                        <input class="btn btn-primary" type="submit" value="Salva"/>
                    </td>
                    {% else %}
                    <td>
                        <p class="bg-{{ form.instance.cssresult }}">{{ form.instance.get_result_display }}</p>
                    </td>
                    <td colspan="2">
                        {{ form.instance.note }}
                    </td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">Nessun controllo visibile prova ad aggiornare la lista dei controlli</td>
                </tr>
                {% endfor %}

            </table>
            <script> $("[id^=id_form-][id$=-result]").click(
                                function() {
                                    $("form").submit()
                                })

            </script>

        </form>

    </div>
</div>

{% endblock body_contents %}

